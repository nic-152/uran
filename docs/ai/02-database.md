# AI Context: Database

## Назначение
Текстовое описание целевой модели данных для управляемого ручного процесса.
Источник текущей реализации: `backend/migrations/0001_init.up.sql`.

## Принципы
- История должна быть неизменяемой: прогон ссылается на `testcase_version`, а не на mutable `testcase`.
- Аналитика должна строиться SQL-запросами без сложных пост-обработок.
- Любое управленческое действие должно оставлять след в `audit_log`.

## Рекомендуемые сущности (целевая модель)

### Библиотека тестов
1. `test_suites`
- Разделы/наборы тестов.

2. `testcases`
- Стабильный identity теста (без хранения полной mutable-логики).

3. `testcase_versions`
- Версия кейса: текст, шаги, критерии, обязательность, оценка времени, сложность.
- Ключевой принцип: run всегда привязывается к версии.

4. `tags`, `testcase_tags`
- Теги для поиска, фильтрации, аналитики.

### Операционная работа
1. `projects`
- Проекты/клиенты/направления.

2. `assets`
- Что тестируется: модель камеры, прошивка, стенд, объект.

3. `runs`
- Контейнер прогона: кто, когда, по чему, статус.
- Статусы: `draft`, `in_progress`, `done`, `locked`.

4. `run_items`
- Состав прогона (список пунктов).
- Содержит ссылку на конкретный `testcase_version`.

5. `run_results`
- Результат по каждому `run_item`: `ok/fail/na`, комментарий, причина fail, timestamps.

6. `attachments`
- Файлы к `run_result` или к `run`.
- Хранятся метаданные и ссылка/ключ файла, не Base64.

### Управление и контроль
1. `users`
- Пользователи и роли.

2. `audit_log`
- Полный трек изменений: actor, action, entity, entity_id, before_json, after_json, timestamp.

3. (опционально) `worklog`
- Явный учёт времени, если потребуется отдельно от таймстампов run.

## Текущая реализация (что уже есть в БД)
- enum: `project_role`, `test_status`
- таблицы: `users`, `projects`, `project_members`, `test_sections`, `test_cases`, `test_runs`, `run_test_results`, `run_test_screenshots`, `auth_refresh_tokens`

Ключевая текущая связка:
- `test_runs` + `run_test_results` + `test_cases`
- `run_test_results` хранит `status (test_status)` и payload результата.

## Миграционный вектор
Чтобы прийти к целевой модели без потери данных:
1. Ввести `testcase_versions`.
2. Добавить `run_items` со ссылкой на `testcase_version_id`.
3. Перенести payload результата в `run_results` (или эволюционировать `run_test_results`).
4. Нормализовать вложения в `attachments`.
5. Добавить/расширить `audit_log`.

## Что обязательно фиксировать для управляемости
- Проект
- Asset (модель камеры, прошивка, стенд/объект)
- Инженер
- Шаблон набора тестов
- Итог прогона и причина FAIL

## Причины FAIL
- Использовать справочник причин (enum/reference table), а не только свободный текст.
- Допускать комментарий как дополнение к выбранной причине.
