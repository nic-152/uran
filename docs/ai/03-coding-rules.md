# AI Context: Coding Rules

## Обязательные правила для ИИ-кодогенерации

1. Data/DB
- Всегда использовать PostgreSQL + `sqlx` для backend-фич, работающих с БД.
- Не вводить ORM.
- SQL-миграции являются источником правды.
- Для run/history логики никогда не терять привязку к версии теста (`testcase_version`).

2. Rust backend
- Запрещено использовать `unwrap()` и `expect()` в production-коде.
- Ошибки API возвращать в JSON: `{ "error": "..." }`.
- Валидацию входа делать до записи в БД.
- Для новых фич применять слои: `handlers` / `services` / `repositories`.
- Все переходы статусов run валидировать как state machine (`draft -> in_progress -> done -> locked`).

3. Roles/RBAC
- Поддерживать роли: `admin`, `lead`, `engineer`, `viewer`.
- Операции lock/unlock и изменение библиотеки тестов должны быть ограничены ролями.

4. Immutable history
- После `locked` изменение результатов напрямую запрещено.
- Корректировки только через controlled flow (новый прогон или спец. процедура), которая обязательно логируется в `audit_log`.

5. Audit first
- Логировать: изменения тестов и версий, изменение состава run, изменения результатов, вложения, роли/права, lock/unlock.
- Формат аудита: `actor`, `action`, `entity`, `entity_id`, `before_json`, `after_json`, `timestamp`.

6. Attachments
- Скриншоты/видео/артефакты хранить как файлы или в object storage.
- В БД хранить только метаданные и ключ/URL.
- Base64 blobs в БД запрещены.

7. Frontend
- Источник правды для бизнес-данных: API/БД.
- LocalStorage разрешён только для UI-настроек (например, тема).

8. Analytics readiness
- Обязательные поля для run: проект, asset, инженер, шаблон тестов, статус, итог, причина fail.
- Причины FAIL — справочник + опциональный комментарий.
- Поддерживать уровни покрытия (`L0/L1/L2`) и не допускать `done/locked` при незакрытом L0.

9. Manual process UX
- Для ручного прогона предусматривать быстрые действия: hotkeys, быстрые статусы, минимизация лишних кликов.
- Массовые операции (например, bulk OK) должны требовать явного подтверждения.

10. AI docs atomicity
- Любое изменение API, БД, ролей, статусов, аудита или workflow обновляет `docs/ai/` в том же коммите.

11. Commit naming
- Только обновление AI-контекста: `docs(ai): ...`
- Код + AI docs: основной тип (`feat:`, `fix:` и т.д.) + явная ссылка на docs(ai).
  - Пример: `feat: add run lock endpoint + docs(ai): define lock workflow`
